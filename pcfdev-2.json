{
    "variables": {
        "version": "0",
        "distro": "pcfdev",
        "cpus": "4",
        "memory": "4096",
        "disk_size": "60",
        "dev": "false",
        "eula_url": "",
        "security_group_id": "",
        "subnet_id": "",
        "vpc_id": "",
        "ssh_keypair_name": "",
        "ssh_private_key_file": ""
    },
    "builders": [
        {
            "type": "amazon-ebs",
            "region": "us-east-1",
            "source_ami": "ami-6012160a",
            "instance_type": "c4.2xlarge",
            "ami_name": "{{user `distro`}}-v{{user `version`}}",
            "ami_description": "{{user `eula_url`}}",
            "associate_public_ip_address": false,
            "security_group_id": "{{user `security_group_id`}}",
            "subnet_id": "{{user `subnet_id`}}",
            "vpc_id": "{{user `vpc_id`}}",
            "ssh_keypair_name": "{{user `ssh_keypair_name`}}",
            "ssh_private_key_file": "{{user `ssh_private_key_file`}}",
            "ami_block_device_mappings": [{
                "device_name": "/dev/sda1",
                "volume_type": "gp2",
                "volume_size": "{{user `disk_size`}}",
                "delete_on_termination": true
            }],
            "launch_block_device_mappings": [{
                "device_name": "/dev/sda1",
                "volume_type": "io1",
                "iops": "1800",
                "volume_size": "{{user `disk_size`}}",
                "delete_on_termination": true
            }],
            "ssh_username": "ubuntu",
            "ssh_timeout": "20m",
            "tags": {"Name": "v{{user `version`}}", "License":"{{user `eula_url`}}"}
        },
        {
            "type": "virtualbox-ovf",
            "source_path": "/Users/pivotal/Documents/pcfdev-1-test.ova",
            "ssh_username": "vcap",
            "ssh_password": "vcap",
            "headless": true,

            "vm_name": "test-{{user `distro`}}-v{{user `version`}}",
            "http_directory": "preseed",
            "ssh_timeout": "20m",
            "shutdown_command": "echo vcap | sudo -S shutdown -P now",
            "format": "ova",
            "boot_command": [
                "<esc><esc><enter><wait>",
                "/install/vmlinuz noapic ",
                "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
                "debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
                "hostname=pcfdev ",
                "fb=false debconf/frontend=noninteractive ",
                "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA ",
                "keyboard-configuration/variant=USA console-setup/ask_detect=false ",
                "initrd=/install/initrd.gz -- <enter>"
            ],
            "vboxmanage": [
                [ "modifyvm", "{{.Name}}", "--cpus", "{{user `cpus`}}" ],
                [ "modifyvm", "{{.Name}}", "--memory", "{{user `memory`}}" ],
                [ "modifyvm", "{{.Name}}", "--natdnshostresolver1", "on" ],
                [ "modifyvm", "{{.Name}}", "--nic1", "nat" ],
                [ "modifyvm", "{{.Name}}", "--paravirtprovider", "minimal" ]
            ]
        }
    ],

    "provisioners": [
        {
            "type": "shell",
            "execute_command": "echo vcap | {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
            "inline": [
                "cp /var/pcfdev/my-file /var/pcfdev/finished"
            ]
        }
    ],
    "post-processors": [
        {
            "type": "shell-local",
            "only": ["virtualbox-ovf"],
            "inline": ["ls $PWD/*/*.ova"],
            "keep_input_artifact": true
        },
        {
            "type": "vagrant",
            "only": ["amazon-ebs"],
            "output": "{{user `distro`}}-{{.Provider}}-v{{user `version`}}.box",
            "keep_input_artifact": true
        }
    ]
}
